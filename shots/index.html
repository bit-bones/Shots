<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Circle Arena Game</title>
    <style>
        html, body { height: 100%; margin: 0; overflow: hidden; }
        body { background: #181c23; display: flex; justify-content: center; align-items: center; }
        canvas { background: #232832; display: block; border: 2px solid #333; }
        #card-choices, #setup-overlay {
            position: absolute;
            left: 50%; top: 50%;
            transform: translate(-50%, -50%);
            z-index: 20;
        }
        #card-choices {
            display: none;
            background: rgba(24,28,35,0.97);
            border-radius: 22px;
            box-shadow: 0 8px 32px #000c, 0 1.5px 0 #65c6ff inset;
            padding: 38px 38px 32px 38px;
            min-width: 700px;
            min-height: 260px;
            flex-direction: row;
            justify-content: center;
            align-items: flex-end;
            gap: 0px;
        }
        .card {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
            background: linear-gradient(160deg, #292f3a 70%, #232832 100%);
            border: 2.5px solid #3d4351;
            color: #fff;
            border-radius: 18px 18px 24px 24px;
            font-family: inherit;
            font-size: 1.13em;
            text-align: center;
            padding: 22px 16px 18px 16px;
            cursor: pointer;
            box-shadow: 0 2px 16px #0007;
            position: relative;
            z-index: 1;
            transition: transform 0.22s cubic-bezier(.4,2,.6,1), box-shadow 0.18s, border 0.13s, color 0.13s;
        }
        .card.card-uniform {
            width: 170px !important;
            height: 220px !important;
            min-width: 0;
            min-height: 0;
            margin: 0;
        }
        .card:hover, .card.selected {
            border: 2.5px solid #65c6ff;
            box-shadow: 0 8px 32px #65c6ff44, 0 2px 24px #000a;
            background: linear-gradient(160deg, #232832 60%, #292f3a 100%);
            color: #65c6ff;
            z-index: 2;
        }
        .card.centered {
            border: 2.5px solid #56ff7a !important;
            color: #56ff7a !important;
            background: linear-gradient(160deg, #1e2a1e 60%, #232832 100%) !important;
            box-shadow: 0 12px 40px #56ff7a55, 0 2px 24px #000a;
            z-index: 10 !important;
            /* transform handled inline for smooth animation */
        }
        .card {
            transition: transform 0.22s cubic-bezier(.4,2,.6,1), box-shadow 0.18s, border 0.13s, color 0.13s;
        }
        .card b {
            font-size: 1.18em;
            margin-bottom: 8px;
            letter-spacing: 0.5px;
        }
        .card small {
            color: #b7e6ff;
            font-size: 0.98em;
            margin-top: 8px;
        }
        .card::after {
            content: '';
            display: block;
            position: absolute;
            left: 50%;
            bottom: 10px;
            width: 60%;
            height: 8px;
            background: radial-gradient(ellipse at center, #65c6ff33 0%, #0000 100%);
            border-radius: 50%;
            transform: translateX(-50%) scaleY(0.7);
            opacity: 0.7;
            pointer-events: none;
        }

        #setup-overlay {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: rgba(25,28,32,0.99);
            border-radius: 18px;
            box-shadow: 0 4px 32px #000c;
            padding: 32px 44px 34px 44px;
            min-width: 330px;
            max-width: 430px;
            width: 390px;
        }
        #setup-overlay h2 {
            color: #65c6ff;
            margin-bottom: 10px;
        }
        #setup-overlay label {
            color: #fff;
            font-size: 1em;
            margin-bottom: 2px;
            display: block;
        }
        #setup-overlay input[type=range] {
            width: 220px;
        }
        #setup-overlay .setup-row {
            margin-bottom: 18px;
            width: 100%;
        }
        #setup-overlay .slider-value {
            color: #ffda72;
            margin-left: 10px;
        }
        #setup-overlay button {
            background: #65c6ff;
            color: #181c23;
            border: none;
            border-radius: 8px;
            padding: 10px 28px;
            font-size: 1.1em;
            font-weight: bold;
            margin-top: 14px;
            cursor: pointer;
            transition: background 0.12s;
        }
        #setup-overlay button:hover {
            background: #56ff7a;
        }
        #setup-overlay .desc {
            color: #b7b7b7;
            font-size: 0.95em;
            margin-bottom: 16px;
            margin-top: -6px;
        }
        /* CARD BADGES UI */
        #cards-ui {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            top: 10px;
            z-index: 10;
            pointer-events: none;
            min-width: 450px;
            font-family: sans-serif;
        }
        .cards-list {
            margin-bottom: 0;
            white-space: nowrap;
        }
        .card-badge {
            display: inline-block;
            background: #292f3a;
            border: 1.2px solid #3d4351;
            border-radius: 6px;
            color: #fff;
            font-size: 0.98em;
            margin: 0 2px 0 2px;
            padding: 3px 10px 2px 10px;
            min-width: 32px;
            min-height: 18px;
            vertical-align: middle;
        }
        .card-badge.none {
            background: #383e47;
            color: #bbb;
            border: 1.2px solid #444;
        }
        .card-badge[title]:hover {
            border: 1.2px solid #65c6ff;
            background: #232832;
            color: #65c6ff;
            z-index: 20;
        }

        /* Info badge styles */
        .setting-row {
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
        }
        .setting-help {
            display: inline-flex;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #3a4050;
            color: #cfd8e3;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            margin-right: 8px;
            margin-left: 0;
            cursor: default;
            border: 1px solid #2f3440;
            position: relative;
        }
        .setting-help[title]:hover::after {
            content: attr(title);
            position: absolute;
            background: #13161a;
            color: #d8e9ff;
            padding: 8px 10px;
            border-radius: 8px;
            box-shadow: 0 6px 20px #0008;
            transform: translateY(-8px);
            white-space: nowrap;
            font-size: 12px;
            left: 50%;
            top: -38px;
            z-index: 60;
        }
        /* Inline row for dynamic rate controls, fixed width, prevent modal stretch */
        #dynamic-rate-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 0;
            margin-left: 16px;
            /* fixed width: */
            width: auto;
            flex-wrap: nowrap;
            justify-content: flex-start;
        }
        #dynamic-rate-row label {
            min-width: 70px;
            margin-bottom: 0;
        }
        #dynamic-rate-row input[type=range] {
            width: 120px;
            min-width: 120px;
        }
    </style>
</head>
<body>
    <canvas id="game" width="1300" height="650"></canvas>
    <div id="card-choices"></div>
    <div id="setup-overlay">
        <h2>Game Setup</h2>
        <div class="desc">Choose obstacle density and size, then start the battle!</div>
        <div class="setup-row">
            <label for="obstacle-density">Obstacle Density:</label>
            <input type="range" id="obstacle-density" min="2" max="15" value="7">
            <span id="density-value" class="slider-value">7</span>
        </div>
        <div class="setup-row">
            <label for="obstacle-size">Obstacle Size:</label>
            <input type="range" id="obstacle-size" min="40" max="200" value="110">
            <span id="size-value" class="slider-value">110</span>
        </div>
        <div class="setup-row">
            <div style="display: flex; align-items: center; width: 100%; gap: 0;">
                <!-- Dynamic toggle row, now horizontal with rate -->
                <div class="setting-row" style="flex:1 1 0; min-width:0;">
                    <div class="setting-help" title="When on, obstacles will spawn and fade during the round.">i</div>
                    <label for="dynamic-mode" style="margin-bottom:0;">Dynamic:</label>
                    <input type="checkbox" id="dynamic-mode" style="margin-right:0;">
                </div>
                <div id="dynamic-rate-row" style="display:none;">
                    <label for="dynamic-rate" style="margin-right:6px; margin-bottom:0;">Rate (sec):</label>
                    <input type="range" id="dynamic-rate" min="0.25" max="6" step="0.05" value="3">
                    <span id="dynamic-rate-value" class="slider-value">3.00</span>
                </div>
            </div>
        </div>
        <div class="setup-row">
            <div class="setting-row">
                <div class="setting-help" title="When on, bullets will bounce off the edges instead of leaving the play area.">i</div>
                <label for="map-border" style="margin-bottom:0;">Map Border:</label>
                <input type="checkbox" id="map-border">
            </div>
        </div>
        <div class="setup-row">
            <label for="enemy-count">Enemy AI:</label>
            <select id="enemy-count">
                <option value="0">0</option>
                <option value="1" selected>1</option>
                <option value="2">2</option>
                <option value="3">3</option>
            </select>
        </div>
        <div class="setup-row">
            <label for="saved-maps">Saved Map:</label>
            <select id="saved-maps">
                <option value="">(none)</option>
            </select>
            <button id="delete-saved-map" style="margin-left:8px;">Delete</button>
            <button id="open-map-editor" style="margin-left:6px;">Map Editor</button>
        </div>
        <div class="setup-row">
            <div class="setting-row">
                <div class="setting-help" title="How many rounds between world modifier selections. World modifiers affect the entire game environment.">i</div>
                <label for="world-modifier-interval" style="margin-bottom:0;">World Modifier Interval:</label>
                <input type="range" id="world-modifier-interval" min="1" max="10" value="3" style="width:120px; margin-left:10px;">
                <span id="world-modifier-value" class="slider-value">3</span>
            </div>
        </div>
        <div style="display:flex; gap:10px; margin-bottom:10px;">
            <button id="start-btn">Start Game</button>
            <button id="open-options-btn">Options</button>
        </div>
        <div style="display:flex; gap:10px;">
            <button id="host-btn">Host / Invite</button>
            <button id="join-btn">Join Game</button>
        </div>
        <!-- Multiplayer Modal -->
        <div id="multiplayer-modal" style="display:none; position:fixed; left:0; top:0; right:0; bottom:0; z-index:3000; background:rgba(0,0,0,0.55); align-items:center; justify-content:center;">
            <div style="background:#232832; border-radius:14px; padding:32px 32px 24px 32px; min-width:340px; max-width:90vw; margin:auto; box-shadow:0 8px 40px #000a; color:#fff; display:flex; flex-direction:column; align-items:center;">
                <div id="mp-host-section" style="display:none; flex-direction:column; align-items:center;">
                    <h3 style="color:#65c6ff; margin-bottom:10px;">Invite a Friend</h3>
                    <div style="margin-bottom:10px;">Share this code or link:</div>
                    <input id="mp-session-code" readonly style="font-size:1.2em; text-align:center; margin-bottom:10px; width:180px; background:#181c23; color:#65c6ff; border:1.5px solid #65c6ff; border-radius:7px; padding:6px 10px;" />
                    <button id="mp-copy-link" style="margin-bottom:10px;">Copy Link</button>
                    <div style="font-size:0.98em; color:#b7e6ff; margin-bottom:10px;">Waiting for player to join...</div>
                </div>
                <div id="mp-join-section" style="display:none; flex-direction:column; align-items:center;">
                    <h3 style="color:#65c6ff; margin-bottom:10px;">Join a Game</h3>
                    <div style="margin-bottom:10px;">Enter code or paste invite link:</div>
                    <input id="mp-join-code" style="font-size:1.2em; text-align:center; margin-bottom:10px; width:180px; background:#181c23; color:#65c6ff; border:1.5px solid #65c6ff; border-radius:7px; padding:6px 10px;" />
                    <button id="mp-join-confirm" style="margin-bottom:10px;">Join</button>
                </div>
                <button id="mp-cancel" style="margin-top:8px; background:#3d4351; color:#fff;">Cancel</button>
            </div>
        </div>
    </div>
    <div id="cards-ui"></div>

    <!-- Options Modal -->
    <div id="options-overlay" style="display:none; position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); z-index:2100;">
        <div style="background:rgba(25,28,32,0.99); border-radius:12px; padding:20px 22px; width:360px; box-shadow:0 8px 40px #000a; color:#fff;">
            <h3 style="margin:4px 0 10px 0; color:#65c6ff;">Options</h3>
            <div style="margin-bottom:10px;"><label style="display:block;">Master Volume: <span id="master-vol-val" style="color:#ffda72; margin-left:8px;">100</span></label>
                <input id="master-vol" type="range" min="0" max="100" value="100" style="width:100%;" /></div>
            <div style="margin-bottom:10px;"><label style="display:block;">Music Volume: <span id="music-vol-val" style="color:#ffda72; margin-left:8px;">100</span></label>
                <input id="music-vol" type="range" min="0" max="100" value="100" style="width:100%;" /></div>
            <div style="margin-bottom:12px;"><label style="display:block;">SFX Volume: <span id="sfx-vol-val" style="color:#ffda72; margin-left:8px;">100</span></label>
                <input id="sfx-vol" type="range" min="0" max="100" value="100" style="width:100%;" /></div>
            <div style="margin-bottom:8px; font-size:0.95em; color:#cfd8e3;">Per-effect volumes</div>
            <div style="margin-bottom:8px; display:flex; align-items:center; gap:8px;"><div style="flex:1 1 0;">
                <label style="display:block;">Shot Volume: <span id="shot-vol-val" style="color:#ffda72; margin-left:8px;">100</span></label>
                <input id="shot-vol" type="range" min="0" max="100" value="100" style="width:100%;" />
                </div>
                <button class="sfx-preview" id="preview-shot" title="Preview Shot" style="width:30px; height:24px;">▶</button>
            </div>
            <div style="margin-bottom:8px; display:flex; align-items:center; gap:8px;"><div style="flex:1 1 0;">
                <label style="display:block;">Explosion Volume: <span id="explosion-vol-val" style="color:#ffda72; margin-left:8px;">100</span></label>
                <input id="explosion-vol" type="range" min="0" max="100" value="100" style="width:100%;" />
                </div>
                <button class="sfx-preview" id="preview-explosion" title="Preview Explosion" style="width:30px; height:24px;">▶</button>
            </div>
            <div style="margin-bottom:8px; display:flex; align-items:center; gap:8px;"><div style="flex:1 1 0;">
                <label style="display:block;">Ricochet Volume: <span id="ricochet-vol-val" style="color:#ffda72; margin-left:8px;">100</span></label>
                <input id="ricochet-vol" type="range" min="0" max="100" value="100" style="width:100%;" />
                </div>
                <button class="sfx-preview" id="preview-ricochet" title="Preview Ricochet" style="width:30px; height:24px;">▶</button>
            </div>
            <div style="margin-bottom:12px; display:flex; align-items:center; gap:8px;"><div style="flex:1 1 0;">
                <label style="display:block;">Hit Volume: <span id="hit-vol-val" style="color:#ffda72; margin-left:8px;">100</span></label>
                <input id="hit-vol" type="range" min="0" max="100" value="100" style="width:100%;" />
                </div>
                <button class="sfx-preview" id="preview-hit" title="Preview Hit" style="width:30px; height:24px;">▶</button>
            </div>
            <div style="margin-bottom:12px; display:flex; align-items:center; gap:8px;"><div style="flex:1 1 0;">
                <label style="display:block;">Dash Volume: <span id="dash-vol-val" style="color:#ffda72; margin-left:8px;">100</span></label>
                <input id="dash-vol" type="range" min="0" max="100" value="100" style="width:100%;" />
                </div>
                <button class="sfx-preview" id="preview-dash" title="Preview Dash" style="width:30px; height:24px;">▶</button>
            </div>
            <div style="display:flex; gap:8px; justify-content:flex-end;">
                <button id="options-back-btn">Back</button>
            </div>
        </div>
    </div>

    <!-- Dev Console (always visible, bottom of screen) -->
    <div id="dev-console-fixed">
        <div id="dev-console-log" tabindex="0"></div>
    <form id="dev-console-form" autocomplete="off">
            <input id="dev-console-input" type="text" placeholder="Type //Card Name or //Card Name/xN..." autocomplete="off" spellcheck="false" />
        </form>
    </div>

    <!-- Map Editor Modal -->
    <div id="map-editor-modal" style="display:none; position:fixed; left:0; top:0; right:0; bottom:0; z-index:2000; background:rgba(0,0,0,0.6); align-items:center; justify-content:center;">
        <div style="background:#1f2329; padding:14px; border-radius:8px; width:940px; max-width:95%; display:flex; gap:12px;">
            <div style="flex:1 1 0;">
                <canvas id="map-editor-canvas" width="780" height="420" style="background:#2a2f36; display:block; border:1px solid #3b424a;"></canvas>
            </div>
            <div style="width:200px; color:#ddd;">
                <h3 style="margin:6px 0 8px 0; color:#fff; font-size:16px;">Map Editor</h3>
                <label>Square Size: <span id="editor-size-val">80</span></label>
                <input id="editor-size" type="range" min="24" max="220" value="80" style="width:100%;" />
                <div style="margin-top:8px; display:flex; align-items:center; gap:8px;">
                    <input type="checkbox" id="editor-grid-snap" />
                    <label for="editor-grid-snap" style="margin:0;">Grid Snap</label>
                </div>
                <div style="margin-top:8px;">
                    <button id="editor-place" style="width:100%; margin-bottom:6px;">Place Mode</button>
                    <button id="editor-erase" style="width:100%; margin-bottom:6px;">Erase Mode</button>
                </div>
                <div style="margin-top:8px;">
                    <input id="editor-map-name" placeholder="Map name" style="width:100%; padding:6px; background:#222; color:#fff; border:1px solid #3b424a;" />
                    <button id="editor-save" style="width:100%; margin-top:6px;">Save Map</button>
                    <button id="editor-clear" style="width:100%; margin-top:6px;">Clear</button>
                </div>
                <div style="margin-top:10px;">
                    <button id="editor-close" style="width:100%;">Close Editor</button>
                </div>
            </div>
        </div>
    </div>

    <script>
    // Ensure dynamic rate row appears inline with dynamic toggle
    document.addEventListener('DOMContentLoaded', function() {
        const dynamicCheckbox = document.getElementById('dynamic-mode');
        const dynamicRateRow = document.getElementById('dynamic-rate-row');
        dynamicCheckbox.addEventListener('change', function() {
            dynamicRateRow.style.display = this.checked ? 'flex' : 'none';
        });
    });
    </script>
    <script src="main.js"></script>
    <style>
    #dev-console-fixed {
        position: fixed;
        left: 0; right: 0; bottom: 0;
        z-index: 1001;
        background: #232832ee;
        border-top: 2px solid #65c6ff;
        box-shadow: 0 -2px 16px #000a;
        padding: 0;
        display: flex;
        flex-direction: column;
        max-width: 100vw;
        min-width: 320px;
        pointer-events: auto;
    }
    #dev-console-log {
        background: #1a1e27;
        color: #e6f2ff;
        font-family: 'Fira Mono', 'Consolas', monospace;
        font-size: 1.01em;
        padding: 10px 18px 8px 18px;
        overflow-y: auto;
        white-space: pre-wrap;
        border-bottom: 1.5px solid #292f3a;
        outline: none;
        user-select: text;
        cursor: text;
        max-height: 120px;
        min-height: 38px;
    }
    #dev-console-input {
        width: 100%; font-size: 1.08em; font-family: inherit;
        background: #232832; color: #fff;
        border: 1.5px solid #65c6ff; border-radius: 7px;
        padding: 8px 12px; margin: 8px 0 8px 0;
        outline: none; box-sizing: border-box;
        transition: border 0.13s;
    }
    #dev-console-input:focus { border-color: #ffd86b; }
    #dev-console-form { margin: 0; padding: 0 18px; }
    </style>
</body>
</html>